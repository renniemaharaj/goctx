{
  "estimated_tokens": 27000,
  "project_tree": ".\ninternal\n  └── ui\n    └── ui.go\n",
  "files": {
    "internal/ui/ui.go": "package ui\n\nimport (\n\t\"encoding/json\"\n\t\"fmt\"\n\t\"goctx/internal/apply\"\n\t\"goctx/internal/builder\"\n\t\"goctx/internal/model\"\n\t\"github.com/gotk3/gotk3/gdk\"\n\t\"github.com/gotk3/gotk3/gtk\"\n\t\"github.com/gotk3/gotk3/glib\"\n\t\"net/http\"\n\t\"os\"\n\t\"path/filepath\"\n\t\"strings\"\n)\n\nvar (\n\tactiveContext  model.ProjectOutput\n\tcurrentPayload string\n\tstatsBuf       *gtk.TextBuffer\n\tstashList      *gtk.ListBox\n)\n\nfunc Run() {\n\tgtk.Init(nil)\n\n\twin, _ := gtk.WindowNew(gtk.WINDOW_TOPLEVEL)\n\twin.SetTitle(\"GoCtx Management Console\")\n\twin.SetDefaultSize(1200, 800)\n\twin.Connect(\"destroy\", gtk.MainQuit)\n\n\thmain, _ := gtk.BoxNew(gtk.ORIENTATION_HORIZONTAL, 0)\n\n\t// --- LEFT BAR (Navigation \u0026 Actions) ---\n\tleftBar, _ := gtk.BoxNew(gtk.ORIENTATION_VERTICAL, 15)\n\tleftBar.SetMarginStart(15)\n\tleftBar.SetMarginEnd(15)\n\tleftBar.SetMarginTop(15)\n\tleftBar.SetSizeRequest(280, -1)\n\n\tbtnBuild := newBtn(\"BUILD CONTEXT\")\n\tbtnCopy := newBtn(\"COPY CONTEXT\")\n\tbtnApply := newBtn(\"APPLY PENDING PATCH\")\n\tbtnApply.SetSensitive(false)\n\n\tleftBar.PackStart(btnBuild, false, false, 0)\n\tleftBar.PackStart(btnCopy, false, false, 0)\n\tleftBar.PackStart(btnApply, false, false, 0)\n\n\tlabel(leftBar, \"SESSION HISTORY\")\n\tswStash, _ := gtk.ScrolledWindowNew(nil, nil)\n\tstashList, _ = gtk.ListBoxNew()\n\tswStash.Add(stashList)\n\tleftBar.PackStart(swStash, true, true, 0)\n\n\t// --- RIGHT CONTENT (Display \u0026 Diff) ---\n\trightStack, _ := gtk.BoxNew(gtk.ORIENTATION_VERTICAL, 10)\n\trightStack.SetMarginStart(20)\n\trightStack.SetMarginEnd(20)\n\trightStack.SetMarginTop(15)\n\n\tlabel(rightStack, \"PROJECT DASHBOARD\")\n\tstatsScroll, _ := gtk.ScrolledWindowNew(nil, nil)\n\tstatsView, _ := gtk.TextViewNew()\n\tstatsView.SetMonospace(true)\n\tstatsView.SetEditable(false)\n\tstatsBuf, _ = statsView.GetBuffer()\n\tstatsScroll.Add(statsView)\n\trightStack.PackStart(statsScroll, true, true, 0)\n\n\t// --- LOGIC: BUILD ---\n\tbtnBuild.Connect(\"clicked\", func() {\n\t\tstatsBuf.SetText(\"Scanning project files...\")\n\t\tgo func() {\n\t\t\tout, err := builder.BuildSelectiveContext(\".\", nil)\n\t\t\tif err == nil {\n\t\t\t\tactiveContext = out\n\t\t\t\tjs, _ := json.Marshal(out)\n\t\t\t\tcurrentPayload = string(js)\n\t\t\t\tglib.IdleAdd(func() {\n\t\t\t\t\tstatsBuf.SetText(formatStats(activeContext, \"Active Workspace\"))\n\t\t\t\t})\n\t\t\t}\n\t\t}()\n\t})\n\n\t// --- LOGIC: COPY ---\n\tbtnCopy.Connect(\"clicked\", func() {\n\t\tclip, _ := gtk.ClipboardGet(gdk.SELECTION_CLIPBOARD)\n\t\tclip.SetText(currentPayload)\n\t\tglib.IdleAdd(func() { statsBuf.SetText(\"Context copied to clipboard.\\\\n\" + statsBuf.GetText(statsBuf.GetStartIter(), statsBuf.GetEndIter(), true)) })\n\t})\n\n\t// --- LOGIC: STASH SELECTION ---\n\tstashList.Connect(\"row-selected\", func(_ *gtk.ListBox, row *gtk.ListBoxRow) {\n\t\tif row == nil { return }\n\t\tlblWidget, _ := row.GetChild()\n\t\tlbl, _ := lblWidget.(*gtk.Label)\n\t\ttxt, _ := lbl.GetText()\n\t\tpath := filepath.Join(\".stashes\", txt, \"patch.json\")\n\t\tdata, _ := os.ReadFile(path)\n\t\tvar p model.ProjectOutput\n\t\tjson.Unmarshal(data, \u0026p)\n\t\tstatsBuf.SetText(formatStats(p, \"Stash: \"+txt))\n\t})\n\n\t// --- API SERVER (Threaded) ---\n\tgo startAPIServer(btnApply)\n\n\thmain.PackStart(leftBar, false, false, 0)\n\thmain.PackStart(rightStack, true, true, 0)\n\t\n\trefreshStashes(stashList)\n\twin.Add(hmain)\n\twin.ShowAll()\n\tgtk.Main()\n}\n\nfunc startAPIServer(applyBtn *gtk.Button) {\n\thttp.HandleFunc(\"/patch\", func(w http.ResponseWriter, r *http.Request) {\n\t\tif r.Method != http.MethodPost { return }\n\t\tvar patch model.ProjectOutput\n\t\tif err := json.NewDecoder(r.Body).Decode(\u0026patch); err == nil {\n\t\t\tglib.IdleAdd(func() {\n\t\t\t\tstatsBuf.SetText(formatStats(patch, \"INCOMING PATCH DETECTED\"))\n\t\t\t\tapplyBtn.SetSensitive(true)\n\t\t\t\tapplyBtn.Connect(\"clicked\", func() {\n\t\t\t\t\tapply.ApplyPatch(\".\", patch)\n\t\t\t\t\tapplyBtn.SetSensitive(false)\n\t\t\t\t\trefreshStashes(stashList)\n\t\t\t\t})\n\t\t\t})\n\t\t}\n\t})\n\thttp.ListenAndServe(\":8080\", nil)\n}\n\nfunc formatStats(p model.ProjectOutput, title string) string {\n\tvar sb strings.Builder\n\tsb.WriteString(fmt.Sprintf(\"=== %s ===\\\\n\", strings.ToUpper(title)))\n\tsb.WriteString(fmt.Sprintf(\"TOKENS:  %d\\\\n\", p.EstimatedTokens))\n\tsb.WriteString(fmt.Sprintf(\"FILES:   %d\\\\n\\\\n\", len(p.Files)))\n\tsb.WriteString(\"DIRECTORY TREE:\\\\n\")\n\tsb.WriteString(p.ProjectTree)\n\tsb.WriteString(\"\\\\n\\\\nPROPOSED CHANGES:\\\\n\")\n\tfor f := range p.Files {\n\t\tsb.WriteString(\"  [MOD] \" + f + \"\\\\n\")\n\t}\n\treturn sb.String()\n}\n\nfunc refreshStashes(list *gtk.ListBox) {\n\tglib.IdleAdd(func() bool {\n\t\tlist.GetChildren().Foreach(func(item interface{}) { list.Remove(item.(gtk.IWidget)) })\n\t\tos.MkdirAll(\".stashes\", 0755)\n\t\tfilepath.Walk(\".stashes\", func(path string, info os.FileInfo, err error) error {\n\t\t\tif err == nil \u0026\u0026 info.IsDir() \u0026\u0026 path != \".stashes\" \u0026\u0026 filepath.Dir(path) == \".stashes\" {\n\t\t\t\trow, _ := gtk.ListBoxRowNew()\n\t\t\t\tlbl, _ := gtk.LabelNew(filepath.Base(path))\n\t\t\t\trow.Add(lbl)\n\t\t\t\tlist.Add(row)\n\t\t\t}\n\t\t\treturn nil\n\t\t})\n\t\tlist.ShowAll()\n\t\treturn false\n\t})\n}\n\nfunc newBtn(l string) *gtk.Button { b, _ := gtk.ButtonNewWithLabel(l); return b }\nfunc label(box *gtk.Box, t string) { l, _ := gtk.LabelNew(t); l.SetXAlign(0); box.PackStart(l, false, false, 0) }\n"
  }
}