{
  "estimated_tokens": 22000,
  "project_tree": ".\ninternal\n  └── ui\n    └── ui.go\n",
  "files": {
    "internal/ui/ui.go": "package ui\n\nimport (\n\t\"encoding/json\"\n\t\"fmt\"\n\t\"goctx/internal/apply\"\n\t\"goctx/internal/builder\"\n\t\"goctx/internal/model\"\n\t\"github.com/gotk3/gotk3/gdk\"\n\t\"github.com/gotk3/gotk3/gtk\"\n\t\"github.com/gotk3/gotk3/glib\"\n\t\"github.com/webview/webview_go\"\n\t\"os\"\n\t\"path/filepath\"\n\t\"regexp\"\n)\n\nvar currentPayload string\n\nfunc Run() {\n\tgtk.Init(nil)\n\tapplyCSS()\n\n\twin, _ := gtk.WindowNew(gtk.WINDOW_TOPLEVEL)\n\twin.SetTitle(\"GoCtx Orchestrator\")\n\twin.SetDefaultSize(1200, 800)\n\twin.Connect(\"destroy\", gtk.MainQuit)\n\n\thbox, _ := gtk.BoxNew(gtk.ORIENTATION_HORIZONTAL, 0)\n\n\tsidebar, _ := gtk.BoxNew(gtk.ORIENTATION_VERTICAL, 0)\n\tsidebar.SetSizeRequest(250, -1)\n\tlabel(sidebar, \"STASHES\")\n\tlist, _ := gtk.ListBoxNew()\n\n\tmainStack, _ := gtk.BoxNew(gtk.ORIENTATION_VERTICAL, 10)\n\tmainStack.SetMarginStart(20)\n\tmainStack.SetMarginEnd(20)\n\n\tlabel(mainStack, \"PROJECT STATISTICS\")\n\tstatsView, _ := gtk.TextViewNew()\n\tstatsView.SetEditable(false)\n\tstatsView.SetCanFocus(false)\n\tstatsBuf, _ := statsView.GetBuffer()\n\tmainStack.PackStart(statsView, true, true, 0)\n\n\tbtnBox, _ := gtk.BoxNew(gtk.ORIENTATION_HORIZONTAL, 10)\n\tbtnBuild := newBtn(\"Build Context\")\n\tbtnCopy := newBtn(\"Copy Context\")\n\tbtnChat := newBtn(\"Chat\")\n\tbtnPasteApply := newBtn(\"Apply Clipboard\")\n\t\n\tbtnBox.PackStart(btnBuild, true, true, 0)\n\tbtnBox.PackStart(btnCopy, true, true, 0)\n\tbtnBox.PackStart(btnChat, true, true, 0)\n\tbtnBox.PackStart(btnPasteApply, true, true, 0)\n\tmainStack.PackStart(btnBox, false, false, 10)\n\n\tlist.Connect(\"row-selected\", func(_ *gtk.ListBox, row *gtk.ListBoxRow) {\n\t\tif row == nil { return }\n\t\tlblWidget, _ := row.GetChild()\n\t\tlbl, _ := lblWidget.(*gtk.Label)\n\t\ttxt, _ := lbl.GetText()\n\t\tpath := filepath.Join(\".stashes\", txt, \"patch.json\")\n\t\tdata, _ := os.ReadFile(path)\n\t\tcurrentPayload = string(data)\n\t\tstatsBuf.SetText(fmt.Sprintf(\"Loaded Stash: %s\\nSize: %d bytes\", txt, len(data)))\n\t})\n\n\tbtnBuild.Connect(\"clicked\", func() {\n\t\tstatsBuf.SetText(\"Analyzing project...\")\n\t\tgo func() {\n\t\t\tout, _ := builder.BuildSelectiveContext(\".\", nil)\n\t\t\tjs, _ := json.Marshal(out)\n\t\t\tcurrentPayload = string(js)\n\t\t\t\n\t\t\tstats := fmt.Sprintf(\"Files Indexed: %d\\nEstimated Tokens: %d\\nTree Size: %d characters\", \n\t\t\t\tlen(out.Files), out.EstimatedTokens, len(out.ProjectTree))\n\t\t\t\n\t\t\tglib.IdleAdd(func() {\n\t\t\t\tstatsBuf.SetText(stats)\n\t\t\t})\n\t\t}()\n\t})\n\n\tbtnCopy.Connect(\"clicked\", func() {\n\t\tif currentPayload == \"\" { return }\n\t\tclipboard, _ := gtk.ClipboardGet(gdk.SELECTION_CLIPBOARD)\n\t\tclipboard.SetText(currentPayload)\n\t})\n\n\tbtnChat.Connect(\"clicked\", func() {\n\t\t// Running webview without the defer destroy inside the goroutine to prevent premature exit\n\t\tgo func() {\n\t\t\tw := webview.New(false)\n\t\t\tw.SetTitle(\"AI Chat\")\n\t\t\tw.SetSize(1200, 900, webview.Hint(0))\n\t\t\tw.Navigate(\"https://aistudio.google.com\")\n\t\t\tw.Run()\n\t\t}()\n\t})\n\n\tbtnPasteApply.Connect(\"clicked\", func() {\n\t\tclipboard, _ := gtk.ClipboardGet(gdk.SELECTION_CLIPBOARD)\n\t\ttext, _ := clipboard.WaitForText()\n\t\tre := regexp.MustCompile(`(?s)\\{.*\\\"files\\\".*\\}`)\n\t\tmatch := re.FindString(text)\n\t\tif match != \"\" {\n\t\t\tvar patch model.ProjectOutput\n\t\t\tjson.Unmarshal([]byte(match), \u0026patch)\n\t\t\tapply.ApplyPatch(\".\", patch)\n\t\t\trefreshStashes(list)\n\t\t\tstatsBuf.SetText(\"Patch applied successfully\")\n\t\t}\n\t})\n\n\thbox.PackStart(sidebar, false, false, 0)\n\tsidebar.PackStart(list, true, true, 0)\n\thbox.PackStart(mainStack, true, true, 0)\n\trefreshStashes(list)\n\n\twin.Add(hbox)\n\twin.ShowAll()\n\tgtk.Main()\n}\n\nfunc refreshStashes(list *gtk.ListBox) {\n\tglib.IdleAdd(func() bool {\n\t\tlist.GetChildren().Foreach(func(item interface{}) { list.Remove(item.(gtk.IWidget)) })\n\t\tfilepath.Walk(\".stashes\", func(path string, info os.FileInfo, err error) error {\n\t\t\tif err == nil \u0026\u0026 info.IsDir() \u0026\u0026 path != \".stashes\" \u0026\u0026 filepath.Dir(path) == \".stashes\" {\n\t\t\t\trow, _ := gtk.ListBoxRowNew()\n\t\t\t\tlbl, _ := gtk.LabelNew(filepath.Base(path))\n\t\t\t\trow.Add(lbl)\n\t\t\t\tlist.Add(row)\n\t\t\t}\n\t\t\treturn nil\n\t\t})\n\t\tlist.ShowAll()\n\t\treturn false\n\t})\n}\n\nfunc newBtn(l string) *gtk.Button { b, _ := gtk.ButtonNewWithLabel(l); return b }\nfunc label(box *gtk.Box, t string) { l, _ := gtk.LabelNew(t); l.SetXAlign(0); box.PackStart(l, false, false, 5) }\nfunc applyCSS() {\n\tprovider, _ := gtk.CssProviderNew()\n\tprovider.SetData(\"label { font-weight: bold; padding: 5px; } textView { font-family: monospace; font-size: 14px; }\")\n\tscreen, _ := gdk.ScreenGetDefault()\n\tgtk.AddProviderForScreen(screen, provider, gtk.STYLE_PROVIDER_PRIORITY_APPLICATION)\n}\n"
  }
}