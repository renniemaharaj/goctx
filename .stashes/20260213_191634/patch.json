{
  "estimated_tokens": 10500,
  "project_tree": ".\ninternal\n  ‚îî‚îÄ‚îÄ ui\n    ‚îî‚îÄ‚îÄ ui.go\n",
  "files": {
    "internal/ui/ui.go": "package ui\n\nimport (\n\t\"encoding/json\"\n\t\"fmt\"\n\t\"goctx/internal/apply\"\n\t\"goctx/internal/builder\"\n\t\"goctx/internal/browser\"\n\t\"goctx/internal/model\"\n\t\"github.com/gotk3/gotk3/gdk\"\n\t\"github.com/gotk3/gotk3/gtk\"\n\t\"github.com/gotk3/gotk3/glib\"\n\t\"os\"\n\t\"path/filepath\"\n\t\"strings\"\n)\n\nfunc Run() {\n\tgtk.Init(nil)\n\tapplyCSS()\n\n\twin, _ := gtk.WindowNew(gtk.WINDOW_TOPLEVEL)\n\twin.SetTitle(\"‚óè GoCtx AI Orchestrator\")\n\twin.SetDefaultSize(1300, 900)\n\twin.Connect(\"destroy\", gtk.MainQuit)\n\n\thbox, _ := gtk.BoxNew(gtk.ORIENTATION_HORIZONTAL, 0)\n\n\t// --- SIDEBAR (Stashes) ---\n\tsidebar, _ := gtk.BoxNew(gtk.ORIENTATION_VERTICAL, 0)\n\tsidebar.SetSizeRequest(300, -1)\n\tsidebar.GetStyleContext().AddClass(\"sidebar\")\n\tlabel(sidebar, \"EXPLORER: STASHES\")\n\tstashList, _ := gtk.ListBoxNew()\n\trefreshStashes(stashList)\n\tsidebar.PackStart(stashList, true, true, 0)\n\n\t// --- MAIN CONTENT ---\n\tbody, _ := gtk.BoxNew(gtk.ORIENTATION_VERTICAL, 10)\n\tbody.SetMarginStart(20)\n\tbody.SetMarginEnd(20)\n\n\t// Editor (Context/Pipeline Output)\n\tlabel(body, \"CONTEXT EDITOR / PIPELINE LOG\")\n\tsw, _ := gtk.ScrolledWindowNew(nil, nil)\n\ttv, _ := gtk.TextViewNew()\n\ttv.SetMonospace(true)\n\ttv.SetWrapMode(gtk.WRAP_NONE)\n\tbuf, _ := tv.GetBuffer()\n\tsw.Add(tv)\n\tbody.PackStart(sw, true, true, 0)\n\n\t// Large Input Area\n\tlabel(body, \"INSTRUCTIONS (@file to target)\")\n\tpView, _ := gtk.TextViewNew()\n\tpView.SetWrapMode(gtk.WRAP_WORD)\n\tpView.SetSizeRequest(-1, 120)\n\tpBuf, _ := pView.GetBuffer()\n\tbody.PackStart(pView, false, false, 0)\n\n\t// Actions\n\tbtnBox, _ := gtk.BoxNew(gtk.ORIENTATION_HORIZONTAL, 10)\n\tbtnBuild := newBtn(\"Build Context\")\n\tbtnAI := newBtn(\"üöÄ RUN PIPELINE\")\n\tbtnBox.PackStart(btnBuild, true, true, 0)\n\tbtnBox.PackStart(btnAI, true, true, 0)\n\tbody.PackStart(btnBox, false, false, 10)\n\n\t// --- LOGIC ---\n\tbtnBuild.Connect(\"clicked\", func() {\n\t\tout, _ := builder.BuildSelectiveContext(\".\", []string{})\n\t\tjs, _ := json.MarshalIndent(out, \"\", \"  \")\n\t\tbuf.SetText(string(js))\n\t})\n\n\tbtnAI.Connect(\"clicked\", func() {\n\t\tstart, end := pBuf.GetBounds()\n\t\tinstr, _ := pBuf.GetText(start, end, false)\n\t\t\n\t\ttargets := []string{}\n\t\tfor _, w := range strings.Split(instr, \" \") {\n\t\t\tif strings.HasPrefix(w, \"@\") { targets = append(targets, strings.TrimPrefix(w, \"@\")) }\n\t\t}\n\n\t\tgo func() {\n\t\t\tupdateLog := func(msg string) {\n\t\t\t\tglib.IdleAdd(func() { \n\t\t\t\t\titer := buf.GetEndIter()\n\t\t\t\t\tbuf.Insert(iter, \"\\n[PIPELINE] \" + msg)\n\t\t\t\t})\n\t\t\t}\n\n\t\t\tupdateLog(\"Stage 1: Building Selective Context...\")\n\t\t\tcurrCtx, _ := builder.BuildSelectiveContext(\".\", targets)\n\t\t\tctxJS, _ := json.Marshal(currCtx)\n\n\t\t\tupdateLog(\"Stage 2: Poking Rod / Waiting for AI response...\")\n\t\t\tupdated, err := browser.ProcessWithAI(\"TASK: \" + instr + \"\\n\\nSTATE: \" + string(ctxJS))\n\t\t\t\n\t\t\tif err != nil {\n\t\t\t\tupdateLog(\"FAILED: \" + err.Error())\n\t\t\t\treturn\n\t\t\t}\n\n\t\t\tupdateLog(\"Stage 3: Validating AI Output Structure...\")\n\t\t\tupdateLog(\"Stage 4: Applying Patch to Filesystem...\")\n\t\t\t\n\t\t\tglib.IdleAdd(func() {\n\t\t\t\tapply.ApplyPatch(\".\", updated)\n\t\t\t\trefreshStashes(stashList)\n\t\t\t\tupdateLog(\"COMPLETE: Project state synchronized.\")\n\t\t\t})\n\t\t}()\n\t})\n\n\thbox.PackStart(sidebar, false, false, 0)\n\thbox.PackStart(body, true, true, 0)\n\twin.Add(hbox)\n\twin.ShowAll()\n\tgtk.Main()\n}\n\nfunc refreshStashes(list *gtk.ListBox) {\n\tlist.GetChildren().Foreach(func(item interface{}) { list.Remove(item.(gtk.IWidget)) })\n\tfilepath.Walk(\".stashes\", func(path string, info os.FileInfo, err error) error {\n\t\tif err == nil \u0026\u0026 info.IsDir() \u0026\u0026 path != \".stashes\" \u0026\u0026 filepath.Dir(path) == \".stashes\" {\n\t\t\trow, _ := gtk.ListBoxRowNew()\n\t\t\thbox, _ := gtk.BoxNew(gtk.ORIENTATION_HORIZONTAL, 5)\n\t\t\tlbl, _ := gtk.LabelNew(filepath.Base(path))\n\t\t\tbtn := newBtn(\"Apply\")\n\t\t\tbtn.Connect(\"clicked\", func() {\n\t\t\t\tfmt.Println(\"Restoring stash:\", path)\n\t\t\t})\n\t\t\thbox.PackStart(lbl, true, true, 5)\n\t\t\thbox.PackEnd(btn, false, false, 5)\n\t\t\trow.Add(hbox)\n\t\t\tlist.Add(row)\n\t\t}\n\t\treturn nil\n\t})\n\tlist.ShowAll()\n}\n\nfunc newBtn(l string) *gtk.Button { b, _ := gtk.ButtonNewWithLabel(l); return b }\nfunc label(box *gtk.Box, t string) { l, _ := gtk.LabelNew(t); l.SetXAlign(0); box.PackStart(l, false, false, 5) }\nfunc applyCSS() {\n\tprovider, _ := gtk.CssProviderNew()\n\tprovider.LoadFromPath(\"assets/style.css\")\n\tscreen, _ := gdk.ScreenGetDefault()\n\tgtk.AddProviderForScreen(screen, provider, gtk.STYLE_PROVIDER_PRIORITY_APPLICATION)\n}\n"
  }
}