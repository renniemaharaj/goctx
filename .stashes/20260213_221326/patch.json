{
  "estimated_tokens": 42000,
  "project_tree": ".\nagent-instructions.md\ninternal\n  └── ui\n    └── ui.go\n",
  "files": {
    "internal/ui/ui.go": "package ui\n\nimport (\n\t\"encoding/json\"\n\t\"fmt\"\n\t\"goctx/internal/apply\"\n\t\"goctx/internal/builder\"\n\t\"goctx/internal/model\"\n\t\"github.com/gotk3/gotk3/gdk\"\n\t\"github.com/gotk3/gotk3/gtk\"\n\t\"github.com/gotk3/gotk3/glib\"\n\t\"os\"\n\t\"path/filepath\"\n\t\"regexp\"\n\t\"strings\"\n\t\"time\"\n\t\"unicode/utf8\"\n)\n\nvar (\n\tactiveContext   model.ProjectOutput\n\tcurrentPayload  string\n\tlastClipboard   string\n\tstatsBuf        *gtk.TextBuffer\n\tstashList       *gtk.ListBox\n\tpendingList     *gtk.ListBox\n\tpendingPatches  []model.ProjectOutput\n\tselectedStash   model.ProjectOutput\n\twin             *gtk.Window\n)\n\nfunc Run() {\n\tgtk.Init(nil)\n\twin, _ = gtk.WindowNew(gtk.WINDOW_TOPLEVEL)\n\twin.SetTitle(\"GoCtx Manager\")\n\twin.SetDefaultSize(1400, 900)\n\twin.Connect(\"destroy\", gtk.MainQuit)\n\n\thmain, _ := gtk.BoxNew(gtk.ORIENTATION_HORIZONTAL, 0)\n\n\tleftBar, _ := gtk.BoxNew(gtk.ORIENTATION_VERTICAL, 15)\n\tleftBar.SetMarginStart(15); leftBar.SetMarginEnd(15); leftBar.SetMarginTop(15)\n\tleftBar.SetSizeRequest(320, -1)\n\n\tbtnBuild := newBtn(\"CURRENT CONTEXT\")\n\tbtnCopy  := newBtn(\"COPY CONTEXT\")\n\tbtnApplyPatch := newBtn(\"APPLY SELECTED PATCH\")\n\tbtnApplyStash := newBtn(\"APPLY SELECTED STASH\")\n\tbtnApplyPatch.SetSensitive(false); btnApplyStash.SetSensitive(false)\n\n\tleftBar.PackStart(btnBuild, false, false, 0)\n\tleftBar.PackStart(btnCopy, false, false, 0)\n\tleftBar.PackStart(btnApplyPatch, false, false, 0)\n\tleftBar.PackStart(btnApplyStash, false, false, 0)\n\n\tlabel(leftBar, \"PENDING PATCHES\")\n\tswPending, _ := gtk.ScrolledWindowNew(nil, nil)\n\tswPending.SetShadowType(gtk.SHADOW_IN); swPending.SetSizeRequest(-1, 200)\n\tpendingList, _ = gtk.ListBoxNew(); swPending.Add(pendingList)\n\tleftBar.PackStart(swPending, false, false, 0)\n\n\tlabel(leftBar, \"STASHES\")\n\tswStash, _ := gtk.ScrolledWindowNew(nil, nil)\n\tswStash.SetShadowType(gtk.SHADOW_IN)\n\tstashList, _ = gtk.ListBoxNew(); swStash.Add(stashList)\n\tleftBar.PackStart(swStash, true, true, 0)\n\n\trightStack, _ := gtk.BoxNew(gtk.ORIENTATION_VERTICAL, 10)\n\trightStack.SetMarginStart(20); rightStack.SetMarginEnd(20); rightStack.SetMarginTop(15)\n\n\tlabel(rightStack, \"CONTEXT TOOL GUI (GOCTX)\")\n\tstatsScroll, _ := gtk.ScrolledWindowNew(nil, nil)\n\tstatsView, _ := gtk.TextViewNew()\n\tstatsView.SetMonospace(true); statsView.SetEditable(false)\n\tstatsView.SetLeftMargin(25); statsView.SetTopMargin(25)\n\tstatsBuf, _ = statsView.GetBuffer()\n\tstatsScroll.Add(statsView)\n\trightStack.PackStart(statsScroll, true, true, 0)\n\n\twin.Connect(\"button-press-event\", func() {\n\t\tpendingList.UnselectAll(); stashList.UnselectAll()\n\t\tbtnApplyPatch.SetSensitive(false); btnApplyStash.SetSensitive(false)\n\t})\n\n\tbtnBuild.Connect(\"clicked\", func() {\n\t\tgo func() {\n\t\t\tout, err := builder.BuildSelectiveContext(\".\", nil)\n\t\t\tif err == nil {\n\t\t\t\tactiveContext = out; currentPayload = string(mustMarshal(out))\n\t\t\t\tglib.IdleAdd(func() { statsBuf.SetText(formatStats(activeContext, \"Current Workspace State\")) })\n\t\t\t}\n\t\t}()\n\t})\n\n\tbtnCopy.Connect(\"clicked\", func() {\n\t\tclip, _ := gtk.ClipboardGet(gdk.SELECTION_CLIPBOARD)\n\t\tclip.SetText(currentPayload); lastClipboard = currentPayload\n\t\tconfirmAction(\"Context JSON copied to system clipboard.\")\n\t})\n\n\tpendingList.Connect(\"row-selected\", func(_ *gtk.ListBox, row *gtk.ListBoxRow) {\n\t\tif row == nil { return }\n\t\tidx := row.GetIndex()\n\t\tif idx \u003c len(pendingPatches) {\n\t\t\tstatsBuf.SetText(formatStats(pendingPatches[idx], \"Pending Patch Preview\"))\n\t\t\tbtnApplyPatch.SetSensitive(true); btnApplyStash.SetSensitive(false)\n\t\t}\n\t})\n\n\tstashList.Connect(\"row-selected\", func(_ *gtk.ListBox, row *gtk.ListBoxRow) {\n\t\tif row == nil { return }\n\t\tlblWidget, _ := row.GetChild(); lbl, _ := lblWidget.(*gtk.Label); txt, _ := lbl.GetText()\n\t\tdata, err := os.ReadFile(filepath.Join(\".stashes\", txt, \"patch.json\"))\n\t\tif err == nil \u0026\u0026 json.Unmarshal(data, \u0026selectedStash) == nil {\n\t\t\tstatsBuf.SetText(formatStats(selectedStash, \"Stash: \"+txt))\n\t\t\tbtnApplyStash.SetSensitive(true); btnApplyPatch.SetSensitive(false)\n\t\t}\n\t})\n\n\tbtnApplyPatch.Connect(\"clicked\", func() {\n\t\tif confirmAction(\"Apply selected patch?\") {\n\t\t\trow := pendingList.GetSelectedRow()\n\t\t\tapply.ApplyPatch(\".\", pendingPatches[row.GetIndex()])\n\t\t\trefreshStashes(stashList); statsBuf.SetText(\"SYSTEM: Patch applied.\")\n\t\t}\n\t})\n\n\tbtnApplyStash.Connect(\"clicked\", func() {\n\t\tif confirmAction(\"Restore selected stash?\") {\n\t\t\tapply.ApplyPatch(\".\", selectedStash)\n\t\t\trefreshStashes(stashList); statsBuf.SetText(\"SYSTEM: Stash restored.\")\n\t\t}\n\t})\n\n\tgo func() {\n\t\tfor {\n\t\t\ttime.Sleep(1 * time.Second)\n\t\t\tglib.IdleAdd(func() {\n\t\t\t\tclip, _ := gtk.ClipboardGet(gdk.SELECTION_CLIPBOARD)\n\t\t\t\ttext, err := clip.WaitForText()\n\t\t\t\tif err == nil \u0026\u0026 text != \"\" \u0026\u0026 text != lastClipboard {\n\t\t\t\t\tlastClipboard = text; processClipboard(text)\n\t\t\t\t}\n\t\t\t})\n\t\t}\n\t}()\n\n\thmain.PackStart(leftBar, false, false, 0); hmain.PackStart(rightStack, true, true, 0)\n\trefreshStashes(stashList); win.Add(hmain); win.ShowAll(); gtk.Main()\n}\n\nfunc formatStats(p model.ProjectOutput, title string) string {\n\tvar sb strings.Builder\n\tsb.WriteString(fmt.Sprintf(\"=== %s ===\\n\", strings.ToUpper(title)))\n\tsb.WriteString(fmt.Sprintf(\"TOKENS:  %d  |  FILES: %d\\n\\n\", p.EstimatedTokens, len(p.Files)))\n\tsb.WriteString(\"DIRECTORY TREE:\\n\")\n\tsb.WriteString(ensureUTF8(p.ProjectTree))\n\tsb.WriteString(\"\\n\\n--- FILE CONTENT PREVIEW ---\\n\")\n\tfor f, content := range p.Files {\n\t\tsb.WriteString(fmt.Sprintf(\"\\nFILE: %s\\n\", f))\n\t\tsb.WriteString(strings.Repeat(\"━\", len(f)+6) + \"\\n\")\n\t\tif content == \"\" {\n\t\t\tsb.WriteString(\"[DELETION INSTRUCTION]\\n\")\n\t\t} else if !utf8.ValidString(content) {\n\t\t\tsb.WriteString(\"[BINARY OR INVALID UTF-8 DATA - PREVIEW HIDDEN]\\n\")\n\t\t} else {\n\t\t\tsb.WriteString(content + \"\\n\")\n\t\t}\n\t}\n\treturn sb.String()\n}\n\nfunc ensureUTF8(s string) string {\n\tif utf8.ValidString(s) { return s }\n\treturn strings.ToValidUTF8(s, \"\")\n}\n\nfunc confirmAction(msg string) bool {\n\tdlg := gtk.MessageDialogNew(win, gtk.DIALOG_MODAL, gtk.MESSAGE_QUESTION, gtk.BUTTONS_YES_NO, msg)\n\tresp := dlg.Run(); dlg.Destroy(); return resp == gtk.RESPONSE_YES\n}\n\nfunc processClipboard(text string) {\n\tre := regexp.MustCompile(`(?s)\\{.*\\\"files\\\".*\\}`)\n\tmatch := re.FindString(text)\n\tif match != \"\" {\n\t\tvar patch model.ProjectOutput\n\t\tif err := json.Unmarshal([]byte(match), \u0026patch); err == nil {\n\t\t\tpendingPatches = append(pendingPatches, patch)\n\t\t\trow, _ := gtk.ListBoxRowNew()\n\t\t\tlbl, _ := gtk.LabelNew(fmt.Sprintf(\"Patch %d (%d files)\", len(pendingPatches), len(patch.Files)))\n\t\t\trow.Add(lbl); pendingList.Add(row); pendingList.ShowAll()\n\t\t}\n\t}\n}\n\nfunc mustMarshal(v interface{}) []byte { b, _ := json.Marshal(v); return b }\nfunc refreshStashes(list *gtk.ListBox) {\n\tglib.IdleAdd(func() bool {\n\t\tlist.GetChildren().Foreach(func(item interface{}) { list.Remove(item.(gtk.IWidget)) })\n\t\tos.MkdirAll(\".stashes\", 0755)\n\t\tfilepath.Walk(\".stashes\", func(path string, info os.FileInfo, err error) error {\n\t\t\tif err == nil \u0026\u0026 info.IsDir() \u0026\u0026 path != \".stashes\" \u0026\u0026 filepath.Dir(path) == \".stashes\" {\n\t\t\t\trow, _ := gtk.ListBoxRowNew(); lbl, _ := gtk.LabelNew(filepath.Base(path)); row.Add(lbl); list.Add(row)\n\t\t\t}\n\t\t\treturn nil\n\t\t})\n\t\tlist.ShowAll(); return false\n\t})\n}\nfunc newBtn(l string) *gtk.Button { b, _ := gtk.ButtonNewWithLabel(l); return b }\nfunc label(box *gtk.Box, t string) { l, _ := gtk.LabelNew(t); l.SetXAlign(0); box.PackStart(l, false, false, 0) }\n"
  }
}