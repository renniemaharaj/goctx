{
  "estimated_tokens": 55000,
  "project_tree": ".\ninternal\n  └── ui\n    └── ui.go\n",
  "files": {
    "internal/ui/ui.go": "package ui\n\nimport (\n\t\"encoding/json\"\n\t\"fmt\"\n\t\"goctx/internal/apply\"\n\t\"goctx/internal/builder\"\n\t\"goctx/internal/model\"\n\t\"os\"\n\t\"path/filepath\"\n\t\"regexp\"\n\t\"strings\"\n\t\"time\"\n\t\"unicode/utf8\"\n\n\t\"github.com/hexops/gotextdiff\"\n\t\"github.com/hexops/gotextdiff/myers\"\n\t\"github.com/hexops/gotextdiff/span\"\n\t\"github.com/gotk3/gotk3/gdk\"\n\t\"github.com/gotk3/gotk3/glib\"\n\t\"github.com/gotk3/gotk3/gtk\"\n)\n\nvar (\n\tactiveContext  model.ProjectOutput\n\tcurrentPayload string\n\tlastClipboard  string\n\tstatsView      *gtk.TextView\n\tstatsBuf       *gtk.TextBuffer\n\tstashList      *gtk.ListBox\n\tpendingList    *gtk.ListBox\n\tpendingPatches []model.ProjectOutput\n\twin            *gtk.Window\n\tstatusLabel    *gtk.Label\n)\n\nfunc Run() {\n\tgtk.Init(nil)\n\twin, _ = gtk.WindowNew(gtk.WINDOW_TOPLEVEL)\n\twin.SetTitle(\"GoCtx Manager\")\n\twin.SetDefaultSize(1400, 950)\n\n\tvmain, _ := gtk.BoxNew(gtk.ORIENTATION_VERTICAL, 0)\n\thmain, _ := gtk.BoxNew(gtk.ORIENTATION_HORIZONTAL, 0)\n\n\tleftBar, _ := gtk.BoxNew(gtk.ORIENTATION_VERTICAL, 15)\n\tleftBar.SetMarginStart(15); leftBar.SetMarginEnd(15); leftBar.SetMarginTop(15)\n\tleftBar.SetSizeRequest(320, -1)\n\n\tbtnBuild := newBtn(\"CURRENT CONTEXT\")\n\tbtnCopy := newBtn(\"COPY CONTEXT\")\n\tbtnApplyPatch := newBtn(\"APPLY SELECTED PATCH\")\n\n\tleftBar.PackStart(btnBuild, false, false, 0)\n\tleftBar.PackStart(btnCopy, false, false, 0)\n\tleftBar.PackStart(btnApplyPatch, false, false, 0)\n\n\tlabel(leftBar, \"PENDING PATCHES\")\n\tswPending, _ := gtk.ScrolledWindowNew(nil, nil)\n\tswPending.SetShadowType(gtk.SHADOW_IN); swPending.SetSizeRequest(-1, 300)\n\tpendingList, _ = gtk.ListBoxNew(); swPending.Add(pendingList)\n\tleftBar.PackStart(swPending, false, false, 0)\n\n\tlabel(leftBar, \"STASHES\")\n\tswStash, _ := gtk.ScrolledWindowNew(nil, nil)\n\tstashList, _ = gtk.ListBoxNew(); swStash.Add(stashList)\n\tleftBar.PackStart(swStash, true, true, 0)\n\n\trightStack, _ := gtk.BoxNew(gtk.ORIENTATION_VERTICAL, 10)\n\trightStack.SetMarginStart(20); rightStack.SetMarginEnd(20); rightStack.SetMarginTop(15)\n\n\tlabel(rightStack, \"DASHBOARD / DIFF PREVIEW\")\n\tstatsScroll, _ := gtk.ScrolledWindowNew(nil, nil)\n\tstatsView, _ = gtk.TextViewNew()\n\tstatsView.SetMonospace(true); statsView.SetEditable(false)\n\tstatsBuf, _ = statsView.GetBuffer()\n\tsetupTags(statsBuf)\n\tstatsScroll.Add(statsView)\n\trightStack.PackStart(statsScroll, true, true, 0)\n\n\tstatusPanel, _ := gtk.BoxNew(gtk.ORIENTATION_HORIZONTAL, 0)\n\tstatusLabel, _ = gtk.LabelNew(\"Ready\")\n\tstatusPanel.PackStart(statusLabel, false, false, 5)\n\n\thmain.PackStart(leftBar, false, false, 0); hmain.PackStart(rightStack, true, true, 0)\n\tvmain.PackStart(hmain, true, true, 0); vmain.PackStart(statusPanel, false, false, 5)\n\n\tbtnBuild.Connect(\"clicked\", func() {\n\t\tgo func() {\n\t\t\tout, _ := builder.BuildSelectiveContext(\".\", nil)\n\t\t\tactiveContext = out; currentPayload = string(mustMarshal(out))\n\t\t\tglib.IdleAdd(func() { renderText(formatStats(activeContext, \"Current Workspace State\")) })\n\t\t}()\n\t})\n\n\tpendingList.Connect(\"row-selected\", func(_ *gtk.ListBox, row *gtk.ListBoxRow) {\n\t\tif row == nil { return }\n\t\tidx := row.GetIndex()\n\t\tif idx \u003c len(pendingPatches) {\n\t\t\trenderDiff(pendingPatches[idx])\n\t\t\tbtnApplyPatch.SetSensitive(true)\n\t\t}\n\t})\n\n\twin.Add(vmain); win.ShowAll(); gtk.Main()\n}\n\nfunc setupTags(buf *gtk.TextBuffer) {\n\tbuf.CreateTag(\"add\", map[string]interface{}{\"foreground\": \"#2ea44f\"})\n\tbuf.CreateTag(\"rem\", map[string]interface{}{\"foreground\": \"#cf222e\"})\n\tbuf.CreateTag(\"hdr\", map[string]interface{}{\"foreground\": \"#0969da\", \"weight\": 700})\n}\n\nfunc renderText(text string) {\n\tstatsBuf.SetText(text)\n}\n\nfunc renderDiff(p model.ProjectOutput) {\n\tstatsBuf.SetText(\"\")\n\titer := statsBuf.GetStartIter()\n\t\n\tinsertWithTag := func(t string, tagName string) {\n\t\tif tagName != \"\" {\n\t\t\tstatsBuf.InsertWithTagByName(statsBuf.GetEndIter(), t, tagName)\n\t\t} else {\n\t\t\tstatsBuf.Insert(statsBuf.GetEndIter(), t)\n\t\t}\n\t}\n\n\tinsertWithTag(\"=== DIFF PREVIEW ===\\n\\n\", \"hdr\")\n\n\tfor path, newContent := range p.Files {\n\t\toldContent, _ := os.ReadFile(path)\n\t\tedits := myers.ComputeEdits(span.URIFromPath(path), string(oldContent), newContent)\n\t\tdiff := fmt.Sprint(gotextdiff.ToUnified(path, path, string(oldContent), edits))\n\t\n\t\tlines := strings.Split(diff, \"\\n\")\n\t\tfor _, line := range lines {\n\t\t\tif strings.HasPrefix(line, \"+\") \u0026\u0026 !strings.HasPrefix(line, \"+++\") {\n\t\t\t\tinsertWithTag(line+\"\\n\", \"add\")\n\t\t\t} else if strings.HasPrefix(line, \"-\") \u0026\u0026 !strings.HasPrefix(line, \"---\") {\n\t\t\t\tinsertWithTag(line+\"\\n\", \"rem\")\n\t\t\t} else if strings.HasPrefix(line, \"@@\") || strings.HasPrefix(line, \"---\") || strings.HasPrefix(line, \"+++\") {\n\t\t\t\tinsertWithTag(line+\"\\n\", \"hdr\")\n\t\t\t} else {\n\t\t\t\tinsertWithTag(line+\"\\n\", \"\")\n\t\t\t}\n\t\t}\n\t}\n}\n\nfunc mustMarshal(v interface{}) []byte { b, _ := json.Marshal(v); return b }\nfunc newBtn(l string) *gtk.Button { b, _ := gtk.ButtonNewWithLabel(l); return b }\nfunc label(box *gtk.Box, t string) { l, _ := gtk.LabelNew(t); l.SetXAlign(0); box.PackStart(l, false, false, 0) }\nfunc formatStats(p model.ProjectOutput, title string) string { return \"Tree rendering...\" }\n"
  }
}