{
  "estimated_tokens": 9800,
  "project_tree": ".\ninternal\n  ‚îî‚îÄ‚îÄ builder\n    ‚îî‚îÄ‚îÄ builder.go\n  ‚îî‚îÄ‚îÄ browser\n    ‚îî‚îÄ‚îÄ automation.go\n  ‚îî‚îÄ‚îÄ ui\n    ‚îî‚îÄ‚îÄ ui.go\n",
  "files": {
    "internal/browser/automation.go": "package browser\n\nimport (\n\t\"encoding/json\"\n\t\"errors\"\n\t\"goctx/internal/model\"\n\t\"regexp\"\n\t\"time\"\n\t\"github.com/go-rod/rod/lib/input\"\n)\n\nfunc ProcessWithAI(prompt string) (model.ProjectOutput, error) {\n\tb := Get()\n\tpage := b.MustPage(\"https://aistudio.google.com/app/prompts/new\") \n\ttextarea := page.MustElement(\"textarea, [contenteditable=u0027trueu0027]\").MustWaitVisible()\n\ttextarea.MustInput(prompt)\n\tpage.Keyboard.MustType(input.Enter)\n\ttime.Sleep(10 * time.Second)\n\tcontent := page.MustElement(\"body\").MustText()\n\treturn ExtractProjectState(content)\n}\n\nfunc ExtractProjectState(input string) (model.ProjectOutput, error) {\n\tre := regexp.MustCompile(`(?s)\\{.*\\\"files\\\".*\\}`) \n\tmatch := re.FindString(input)\n\tif match == \"\" { return model.ProjectOutput{}, errors.New(\"no JSON found\") }\n\tvar out model.ProjectOutput\n\terr := json.Unmarshal([]byte(match), \u0026out)\n\treturn out, err\n}",
    "internal/builder/builder.go": "package builder\n\nimport (\n\t\"goctx/internal/model\"\n\t\"os\"\n\t\"path/filepath\"\n\t\"strings\"\n)\n\nfunc BuildSelectiveContext(root string, targets []string) (model.ProjectOutput, error) {\n\tout := model.ProjectOutput{Files: make(map[string]string)}\n\tfilepath.Walk(root, func(path string, info os.FileInfo, err error) error {\n\t\tif err != nil || info.IsDir() || strings.Contains(path, \".git\") || strings.Contains(path, \".stashes\") { return nil }\n\t\trel, _ := filepath.Rel(root, path)\n\t\tif len(targets) == 0 {\n\t\t\tc, _ := os.ReadFile(path)\n\t\t\tout.Files[rel] = string(c)\n\t\t\treturn nil\n\t\t}\n\t\tfor _, t := range targets {\n\t\t\tif strings.Contains(rel, t) {\n\t\t\t\tc, _ := os.ReadFile(path)\n\t\t\tout.Files[rel] = string(c)\n\t\t\t}\n\t\t}\n\t\treturn nil\n\t})\n\treturn out, nil\n}",
    "internal/ui/ui.go": "package ui\n\nimport (\n\t\"encoding/json\"\n\t\"goctx/internal/apply\"\n\t\"goctx/internal/builder\"\n\t\"goctx/internal/browser\"\n\t\"goctx/internal/model\"\n\t\"github.com/gotk3/gotk3/gdk\"\n\t\"github.com/gotk3/gotk3/gtk\"\n\t\"github.com/gotk3/gotk3/glib\"\n\t\"strings\"\n)\n\nfunc Run() {\n\tgtk.Init(nil)\n\tapplyCSS()\n\twin, _ := gtk.WindowNew(gtk.WINDOW_TOPLEVEL)\n\twin.SetTitle(\"‚óè GoCtx Selective Patch\")\n\twin.SetDefaultSize(1200, 800)\n\twin.Connect(\"destroy\", gtk.MainQuit)\n\n\tbody, _ := gtk.BoxNew(gtk.ORIENTATION_VERTICAL, 10)\n\tsw, _ := gtk.ScrolledWindowNew(nil, nil)\n\ttv, _ := gtk.TextViewNew()\n\ttv.SetMonospace(true)\n\tbuf, _ := tv.GetBuffer()\n\tsw.Add(tv)\n\tbody.PackStart(sw, true, true, 0)\n\n\tlabel(body, \"INSTRUCTIONS (Use @filename to target files)\")\n\tpromptView, _ := gtk.TextViewNew()\n\tpBuf, _ := promptView.GetBuffer()\n\tbody.PackStart(promptView, false, false, 0)\n\n\tbtnAI := newBtn(\"üöÄ APPLY SMART PATCH\")\n\tbody.PackStart(btnAI, false, false, 20)\n\n\tbtnAI.Connect(\"clicked\", func() {\n\t\tstart, end := pBuf.GetBounds()\n\t\tinstr, _ := pBuf.GetText(start, end, false)\n\t\ttargets := []string{}\n\t\tfor _, w := range strings.Split(instr, \" \") {\n\t\t\tif strings.HasPrefix(w, \"@\") { targets = append(targets, strings.TrimPrefix(w, \"@\")) }\n\t\t}\n\n\t\tcurrCtx, _ := builder.BuildSelectiveContext(\".\", targets)\n\t\tctxJS, _ := json.Marshal(currCtx)\n\t\tgo func() {\n\t\t\tupdated, err := browser.ProcessWithAI(\"TASK: \" + instr + \"\\n\\nSTATE: \" + string(ctxJS))\n\t\t\tglib.IdleAdd(func() {\n\t\t\t\tif err != nil { buf.SetText(\"// Error: \" + err.Error()); return }\n\t\t\t\tapply.ApplyPatch(\".\", updated)\n\t\t\t\tbuf.SetText(\"// Patch applied successfully\")\n\t\t\t})\n\t\t}()\n\t})\n\n\twin.Add(body)\n\twin.ShowAll()\n\tgtk.Main()\n}\n\nfunc newBtn(l string) *gtk.Button {\n\tb, _ := gtk.ButtonNewWithLabel(l)\n\treturn b\n}\n\nfunc label(box *gtk.Box, t string) {\n\tl, _ := gtk.LabelNew(t)\n\tl.SetXAlign(0)\n\tl.SetMarginStart(10)\n\tbox.PackStart(l, false, false, 5)\n}\n\nfunc applyCSS() {\n\tprovider, _ := gtk.CssProviderNew()\n\tprovider.LoadFromPath(\"assets/style.css\")\n\tscreen, _ := gdk.ScreenGetDefault()\n\tgtk.AddProviderForScreen(screen, provider, gtk.STYLE_PROVIDER_PRIORITY_APPLICATION)\n}\n"
  }
}