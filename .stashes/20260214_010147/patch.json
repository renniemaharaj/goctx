{
  "estimated_tokens": 6200,
  "project_tree": ".ctxignore\nassets\n  └── style.css\ninternal\n  ├── apply\n  │   └── apply.go\n  ├── builder\n  │   └── builder.go\n  ├── model\n  │   └── types.go\n  ├── stash\n  │   └── stash.go\n  └── ui\n      ├── actions.go\n      ├── render.go\n      ├── state.go\n      └── ui.go\nmain.go\ngo.mod",
  "files": {
    "assets/style.css": "window { background-color: #1e1e1e; color: #d4d4d4; }\n.sidebar { background-color: #252526; border-right: 1px solid #333; }\nbutton { background: #0e639c; color: white; padding: 8px; border: none; }\nbutton:hover { background: #1177bb; }\nlabel.header { font-weight: bold; color: #858585; text-transform: uppercase; }",
    "go.mod": "module goctx\n\ngo 1.25\n\nrequire (\n\tgithub.com/gotk3/gotk3 v0.6.1\n\tgithub.com/sergi/go-diff v1.3.1\n)",
    "internal/apply/apply.go": "package apply\n\nimport (\n\t\"os\"\n\t\"path/filepath\"\n\t\"goctx/internal/model\"\n\t\"goctx/internal/stash\"\n)\n\nfunc ApplyPatch(root string, input model.ProjectOutput) error {\n\tid, _ := stash.CreateStash(root, input)\n\tfor rel, content := range input.Files {\n\t\tpath := filepath.Join(root, rel)\n\t\tos.MkdirAll(filepath.Dir(path), 0755)\n\t\tos.WriteFile(path, []byte(content), 0644)\n\t}\n\treturn stash.MarkApplied(root, id)\n}",
    "internal/stash/stash.go": "package stash\n\nimport (\n\t\"encoding/json\"\n\t\"os\"\n\t\"path/filepath\"\n\t\"time\"\n\t\"goctx/internal/model\"\n)\n\nfunc CreateStash(root string, patch model.ProjectOutput) (string, error) {\n\tid := time.Now().Format(\"20060102_150405\")\n\tbase := filepath.Join(root, \".stashes\", id)\n\tos.MkdirAll(filepath.Join(base, \"backup\"), 0755)\n\n\tfor rel := range patch.Files {\n\t\toriginal := filepath.Join(root, rel)\n\t\tif data, err := os.ReadFile(original); err == nil {\n\t\t\tbackupPath := filepath.Join(base, \"backup\", rel)\n\t\t\tos.MkdirAll(filepath.Dir(backupPath), 0755)\n\t\t\tos.WriteFile(backupPath, data, 0644)\n\t\t}\n\t}\n\tjsonP, _ := json.Marshal(patch)\n\tos.WriteFile(filepath.Join(base, \"patch.json\"), jsonP, 0644)\n\treturn id, nil\n}\n\nfunc MarkApplied(root, id string) error {\n\tmeta := map[string]string{\"applied\": \"true\", \"at\": time.Now().String()}\n\td, _ := json.Marshal(meta)\n\treturn os.WriteFile(filepath.Join(root, \".stashes\", id, \"meta.json\"), d, 0644)\n}",
    "internal/ui/actions.go": "package ui\n\nimport (\n\t\"encoding/json\"\n\t\"fmt\"\n\t\"os\"\n\t\"path/filepath\"\n\t\"strings\"\n\t\"time\"\n\t\"goctx/internal/apply\"\n\t\"goctx/internal/builder\"\n\t\"goctx/internal/model\"\n\t\"github.com/gotk3/gotk3/gdk\"\n\t\"github.com/gotk3/gotk3/glib\"\n\t\"github.com/gotk3/gotk3/gtk\"\n)\n\nfunc (a *App) bindSignals() {\n\ta.btnBuild.Connect(\"clicked\", func() {\n\t\tout, _ := builder.BuildSelectiveContext(\".\", nil)\n\t\ta.activeContext = out\n\t\ta.RenderDiff(out, \"Workspace State\")\n\t\ta.statusLabel.SetText(\"Context Updated\")\n\t})\n\n\ta.btnCopy.Connect(\"clicked\", func() {\n\t\tclip, _ := gtk.ClipboardGet(gdk.SELECTION_CLIPBOARD)\n\t\tdata, _ := json.Marshal(a.activeContext)\n\t\tclip.SetText(string(data))\n\t\ta.statusLabel.SetText(\"JSON Copied\")\n\t})\n\n\ta.pendingList.Connect(\"row-selected\", func(_ *gtk.ListBox, row *gtk.ListBoxRow) {\n\t\tif row == nil { return }\n\t\tpatch := a.pendingPatches[row.GetIndex()]\n\t\ta.RenderDiff(patch, \"Patch Preview\")\n\t\ta.btnApplyPatch.SetSensitive(true)\n\t})\n\n\ta.btnApplyPatch.Connect(\"clicked\", func() {\n\t\trow := a.pendingList.GetSelectedRow()\n\t\tapply.ApplyPatch(\".\", a.pendingPatches[row.GetIndex()])\n\t\ta.refreshStashes()\n\t\ta.statusLabel.SetText(\"Patch Applied\")\n\t})\n}\n\nfunc (a *App) startClipboardWorker() {\n\tgo func() {\n\t\tfor {\n\t\t\ttime.Sleep(1 * time.Second)\n\t\t\tglib.IdleAdd(func() {\n\t\t\t\tclip, _ := gtk.ClipboardGet(gdk.SELECTION_CLIPBOARD)\n\t\t\t\ttxt, _ := clip.WaitForText()\n\t\t\t\tif txt != \"\" \u0026\u0026 txt != a.lastClipboard \u0026\u0026 strings.Contains(txt, \"\\\"files\\\"\") {\n\t\t\t\t\ta.lastClipboard = txt\n\t\t\t\t\tvar p model.ProjectOutput\n\t\t\t\t\tif json.Unmarshal([]byte(txt), \u0026p) == nil {\n\t\t\t\t\t\ta.mu.Lock()\n\t\t\t\t\t\ta.pendingPatches = append(a.pendingPatches, p)\n\t\t\t\t\t\ta.mu.Unlock()\n\t\t\t\t\t\trow, _ := gtk.ListBoxRowNew()\n\t\t\t\t\t\tlbl, _ := gtk.LabelNew(fmt.Sprintf(\"Patch %d\", len(a.pendingPatches)))\n\t\t\t\t\t\trow.Add(lbl)\n\t\t\t\t\t\ta.pendingList.Add(row)\n\t\t\t\t\t\ta.pendingList.ShowAll()\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t})\n\t\t}\n\t}()\n}\n\nfunc (a *App) refreshStashes() {\n\tos.MkdirAll(\".stashes\", 0755)\n\ta.stashList.GetChildren().Foreach(func(v interface{}) { a.stashList.Remove(v.(gtk.IWidget)) })\n\tfilepath.Walk(\".stashes\", func(path string, info os.FileInfo, err error) error {\n\t\tif err == nil \u0026\u0026 info.IsDir() \u0026\u0026 path != \".stashes\" {\n\t\t\trow, _ := gtk.ListBoxRowNew()\n\t\t\tlbl, _ := gtk.LabelNew(filepath.Base(path))\n\t\t\trow.Add(lbl)\n\t\t\ta.stashList.Add(row)\n\t\t}\n\t\treturn nil\n\t})\n\ta.stashList.ShowAll()\n}",
    "internal/ui/render.go": "package ui\n\nimport (\n\t\"fmt\"\n\t\"os\"\n\t\"strings\"\n\t\"goctx/internal/model\"\n\t\"github.com/gotk3/gotk3/gtk\"\n\t\"github.com/sergi/go-diff/diffmatchpatch\"\n)\n\nfunc (a *App) setupDiffPane(tv *gtk.TextView) {\n\ttv.SetMonospace(true)\n\ttv.SetEditable(false)\n\ttv.SetLeftMargin(20); tv.SetTopMargin(20)\n\tbuf, _ := tv.GetBuffer()\n\ttab := buf.GetTagTable()\n\n\ttagA, _ := gtk.TextTagNew(\"added\")\n\ttagA.SetProperty(\"background\", \"#1e3a1e\")\n\ttagA.SetProperty(\"foreground\", \"#afffbc\")\n\ttagD, _ := gtk.TextTagNew(\"deleted\")\n\ttagD.SetProperty(\"background\", \"#4b1818\")\n\ttagD.SetProperty(\"foreground\", \"#ffa1a1\")\n\ttagH, _ := gtk.TextTagNew(\"header\")\n\ttagH.SetProperty(\"weight\", 700)\n\ttagH.SetProperty(\"foreground\", \"#569cd6\")\n\n\ttab.Add(tagA); tab.Add(tagD); tab.Add(tagH)\n}\n\nfunc (a *App) RenderDiff(p model.ProjectOutput, title string) {\n\tbuf, _ := a.diffView.GetBuffer()\n\tbuf.SetText(\"\")\n\titer := buf.GetStartIter()\n\tbuf.Insert(iter, fmt.Sprintf(\"=== %s ===\\nFILES: %d\\n\\n\", strings.ToUpper(title), len(p.Files)))\n\n\tdmp := diffmatchpatch.New()\n\tfor path, newContent := range p.Files {\n\t\thTag, _ := buf.GetTagTable().Lookup(\"header\")\n\t\taTag, _ := buf.GetTagTable().Lookup(\"added\")\n\t\tdTag, _ := buf.GetTagTable().Lookup(\"deleted\")\n\n\t\tbuf.InsertWithTag(buf.GetEndIter(), fmt.Sprintf(\"\\nFILE: %s\\n\", path), hTag)\n\t\tbuf.Insert(buf.GetEndIter(), strings.Repeat(\"━\", len(path)+6)+\"\\n\")\n\n\t\told, _ := os.ReadFile(path)\n\t\tdiffs := dmp.DiffMain(string(old), newContent, false)\n\t\tdiffs = dmp.DiffCleanupSemantic(diffs)\n\n\t\tfor _, d := range diffs {\n\t\t\tend := buf.GetEndIter()\n\t\t\tswitch d.Type {\n\t\t\tcase diffmatchpatch.DiffInsert: buf.InsertWithTag(end, d.Text, aTag)\n\t\t\tcase diffmatchpatch.DiffDelete: buf.InsertWithTag(end, d.Text, dTag)\n\t\t\tdefault: buf.Insert(end, d.Text)\n\t\t\t}\n\t\t}\n\t}\n}",
    "internal/ui/state.go": "package ui\n\nimport (\n\t\"sync\"\n\t\"goctx/internal/model\"\n\t\"github.com/gotk3/gotk3/gtk\"\n)\n\ntype App struct {\n\twin            *gtk.Window\n\tdiffView       *gtk.TextView\n\tpendingList    *gtk.ListBox\n\tstashList      *gtk.ListBox\n\tstatusLabel    *gtk.Label\n\t\n\tbtnBuild       *gtk.Button\n\tbtnCopy        *gtk.Button\n\tbtnApplyPatch  *gtk.Button\n\tbtnApplyStash  *gtk.Button\n\n\tactiveContext  model.ProjectOutput\n\tpendingPatches []model.ProjectOutput\n\tselectedStash  model.ProjectOutput\n\t\n\tlastClipboard  string\n\tmu             sync.Mutex\n}\n\nfunc NewApp() *App {\n\treturn \u0026App{pendingPatches: []model.ProjectOutput{}}\n}",
    "internal/ui/ui.go": "package ui\n\nimport (\n\t\"github.com/gotk3/gotk3/gtk\"\n)\n\nfunc Run() {\n\tgtk.Init(nil)\n\tapp := NewApp()\n\n\twin, _ := gtk.WindowNew(gtk.WINDOW_TOPLEVEL)\n\tapp.win = win\n\twin.SetTitle(\"GoCtx Manager\")\n\twin.SetDefaultSize(1400, 900)\n\twin.Connect(\"destroy\", gtk.MainQuit)\n\n\tvMain, _ := gtk.BoxNew(gtk.ORIENTATION_VERTICAL, 0)\n\tpaned, _ := gtk.PanedNew(gtk.ORIENTATION_HORIZONTAL)\n\n\t// Sidebar\n\tsidebar, _ := gtk.BoxNew(gtk.ORIENTATION_VERTICAL, 10)\n\tsidebar.SetMarginStart(10); sidebar.SetMarginEnd(10); sidebar.SetMarginTop(10)\n\tsidebar.SetSizeRequest(320, -1)\n\n\tapp.btnBuild = newBtn(\"CURRENT CONTEXT\")\n\tapp.btnCopy = newBtn(\"COPY CONTEXT\")\n\tapp.btnApplyPatch = newBtn(\"APPLY SELECTED PATCH\")\n\tapp.btnApplyStash = newBtn(\"APPLY SELECTED STASH\")\n\t\n\tsidebar.PackStart(app.btnBuild, false, false, 0)\n\tsidebar.PackStart(app.btnCopy, false, false, 0)\n\tsidebar.PackStart(app.btnApplyPatch, false, false, 0)\n\tsidebar.PackStart(app.btnApplyStash, false, false, 0)\n\n\taddHeader(sidebar, \"PENDING PATCHES\")\n\tapp.pendingList, _ = gtk.ListBoxNew()\n\tswP, _ := gtk.ScrolledWindowNew(nil, nil)\n\tswP.SetSizeRequest(-1, 250); swP.Add(app.pendingList)\n\tsidebar.PackStart(swP, false, false, 0)\n\n\taddHeader(sidebar, \"STASHES\")\n\tapp.stashList, _ = gtk.ListBoxNew()\n\tswS, _ := gtk.ScrolledWindowNew(nil, nil)\n\tswS.Add(app.stashList)\n\tsidebar.PackStart(swS, true, true, 0)\n\n\t// Dashboard\n\tdashboard, _ := gtk.BoxNew(gtk.ORIENTATION_VERTICAL, 10)\n\tdashboard.SetMarginStart(10); dashboard.SetMarginTop(10)\n\tswD, _ := gtk.ScrolledWindowNew(nil, nil)\n\tapp.diffView, _ = gtk.TextViewNew()\n\tapp.setupDiffPane(app.diffView)\n\tswD.Add(app.diffView)\n\tdashboard.PackStart(swD, true, true, 0)\n\n\tapp.statusLabel, _ = gtk.LabelNew(\"Ready\")\n\t\n\tpaned.Pack1(sidebar, false, false)\n\tpaned.Pack2(dashboard, true, false)\n\tvMain.PackStart(paned, true, true, 0)\n\tvMain.PackStart(app.statusLabel, false, false, 5)\n\n\twin.Add(vMain)\n\tapp.bindSignals()\n\tapp.refreshStashes()\n\tapp.startClipboardWorker()\n\n\twin.ShowAll()\n\tgtk.Main()\n}\n\nfunc newBtn(l string) *gtk.Button { b, _ := gtk.ButtonNewWithLabel(l); return b }\nfunc addHeader(box *gtk.Box, t string) { l, _ := gtk.LabelNew(t); l.SetXAlign(0); box.PackStart(l, false, false, 5) }",
    "main.go": "package main\n\nimport (\n\t\"os\"\n\t\"goctx/internal/ui\"\n)\n\nfunc main() {\n\tui.Run()\n}"
  }
}