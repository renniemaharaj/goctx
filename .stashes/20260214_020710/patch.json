{
  "estimated_tokens": 0,
  "project_tree": "",
  "files": {
    "internal/ui/ui.go": "package ui\n\nimport (\n\t\"fmt\"\n\t\"goctx/internal/builder\"\n\t\"goctx/internal/model\"\n\t\"os\"\n\t\"sort\"\n\t\"unicode/utf8\"\n\t\"github.com/gotk3/gotk3/glib\"\n\t\"github.com/gotk3/gotk3/gtk\"\n\t\"github.com/gotk3/gotk3/pango\"\n\t\"github.com/sergi/go-diff/diffmatchpatch\"\n)\n\nvar (\n\tactiveContext  model.ProjectOutput\n\tstatsBuf       *gtk.TextBuffer\n\twin            *gtk.Window\n)\n\nfunc Run() {\n\tgtk.Init(nil)\n\twin, _ = gtk.WindowNew(gtk.WINDOW_TOPLEVEL)\n\twin.SetTitle(\"GoCtx Manager v2.6\")\n\twin.SetDefaultSize(1200, 800)\n\twin.Connect(\"destroy\", gtk.MainQuit)\n\n\tgrid, _ := gtk.GridNew()\n\tgrid.SetColumnSpacing(10)\n\tgrid.SetRowSpacing(10)\n\tgrid.SetBorderWidth(10)\n\n\tsidebar, _ := gtk.BoxNew(gtk.ORIENTATION_VERTICAL, 10)\n\tsidebar.SetSizeRequest(250, -1)\n\n\tbtnBuild := newBtn(\"BUILD CONTEXT\")\n\tsidebar.PackStart(btnBuild, false, false, 0)\n\tgrid.Attach(sidebar, 0, 0, 1, 1)\n\n\tsw, _ := gtk.ScrolledWindowNew(nil, nil)\n\tsw.SetHExpand(true)\n\tsw.SetVExpand(true)\n\tsw.SetPolicy(gtk.POLICY_AUTOMATIC, gtk.POLICY_AUTOMATIC)\n\n\tstatsView, _ := gtk.TextViewNew()\n\tstatsView.SetMonospace(true)\n\tstatsView.SetEditable(false)\n\t\n\tstatsBuf, _ = statsView.GetBuffer()\n\tsetupTags(statsBuf)\n\tsw.Add(statsView)\n\tgrid.Attach(sw, 1, 0, 1, 1)\n\n\tbtnBuild.Connect(\"clicked\", func() {\n\t\tgo func() {\n\t\t\tout, err := builder.BuildSelectiveContext(\".\", \"Manual Build\")\n\t\t\tif err == nil {\n\t\t\t\tactiveContext = out\n\t\t\t\tglib.IdleAdd(func() {\n\t\t\t\t\trenderDiff(activeContext)\n\t\t\t\t})\n\t\t\t}\n\t\t}()\n\t})\n\n\twin.Add(grid)\n\twin.ShowAll()\n\tgtk.Main()\n}\n\nfunc setupTags(b *gtk.TextBuffer) {\n\ttab, _ := b.GetTagTable()\n\ta, _ := gtk.TextTagNew(\"added\"); a.SetProperty(\"foreground\", \"#2ecc71\"); tab.Add(a)\n\td, _ := gtk.TextTagNew(\"deleted\"); d.SetProperty(\"foreground\", \"#e74c3c\"); tab.Add(d)\n\th, _ := gtk.TextTagNew(\"header\"); h.SetProperty(\"foreground\", \"#3498db\"); h.SetProperty(\"weight\", 700); tab.Add(h)\n\twar, _ := gtk.TextTagNew(\"warn\"); war.SetProperty(\"foreground\", \"#f39c12\"); war.SetProperty(\"style\", pango.STYLE_ITALIC); tab.Add(war)\n}\n\nfunc getTag(name string) *gtk.TextTag {\n\ttab, err := statsBuf.GetTagTable()\n\tif err != nil {\n\t\treturn nil\n\t}\n\ttag, _ := tab.Lookup(name)\n\treturn tag\n}\n\nfunc renderDiff(p model.ProjectOutput) {\n\tstatsBuf.SetText(\"\")\n\tdmp := diffmatchpatch.New()\n\t\n\tvar keys []string\n\tfor k := range p.Files { keys = append(keys, k) }\n\tsort.Strings(keys)\n\n\trenderCount := 0\n\tconst limit = 10\n\n\tfor _, path := range keys {\n\t\tif renderCount \u003e= limit { break }\n\t\tcontent := p.Files[path]\n\t\tif !utf8.ValidString(content) { continue }\n\n\t\tstatsBuf.InsertWithTag(statsBuf.GetEndIter(), \"\\nFILE: \"+path+\"\\n\", getTag(\"header\"))\n\t\told, _ := os.ReadFile(path)\n\t\toldStr := string(old)\n\t\tif !utf8.ValidString(oldStr) { oldStr = \"[Binary or Invalid UTF-8 Content]\" }\n\t\t\n\t\tdiffs := dmp.DiffMain(oldStr, content, false)\n\t\tfor _, d := range diffs {\n\t\t\tif utf8.ValidString(d.Text) {\n\t\t\t\tswitch d.Type {\n\t\t\t\tcase diffmatchpatch.DiffInsert: statsBuf.InsertWithTag(statsBuf.GetEndIter(), d.Text, getTag(\"added\"))\n\t\t\t\tcase diffmatchpatch.DiffDelete: statsBuf.InsertWithTag(statsBuf.GetEndIter(), d.Text, getTag(\"deleted\"))\n\t\t\t\tdefault: statsBuf.Insert(statsBuf.GetEndIter(), d.Text)\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\trenderCount++\n\t}\n\n\tif len(keys) \u003e limit {\n\t\tmsg := fmt.Sprintf(\"\\n\\n--- PREVIEW LIMIT REACHED: %d/%d files rendered ---\", limit, len(keys))\n\t\tstatsBuf.InsertWithTag(statsBuf.GetEndIter(), msg, getTag(\"warn\"))\n\t}\n}\n\nfunc newBtn(l string) *gtk.Button { b, _ := gtk.ButtonNewWithLabel(l); return b }\n"
  }
}