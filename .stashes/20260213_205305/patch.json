{
  "estimated_tokens": 25000,
  "project_tree": ".\ninternal\n  └── ui\n    └── ui.go\n",
  "files": {
    "internal/ui/ui.go": "package ui\n\nimport (\n\t\"encoding/json\"\n\t\"fmt\"\n\t\"goctx/internal/apply\"\n\t\"goctx/internal/builder\"\n\t\"goctx/internal/model\"\n\t\"github.com/gotk3/gotk3/gdk\"\n\t\"github.com/gotk3/gotk3/gtk\"\n\t\"github.com/gotk3/gotk3/glib\"\n\t\"github.com/webview/webview_go\"\n\t\"os\"\n\t\"path/filepath\"\n\t\"regexp\"\n\t\"strings\"\n)\n\nvar activeContext model.ProjectOutput\nvar currentPayload string\n\nfunc Run() {\n\tgtk.Init(nil)\n\n\twin, _ := gtk.WindowNew(gtk.WINDOW_TOPLEVEL)\n\twin.SetTitle(\"GoCtx Manager\")\n\twin.SetDefaultSize(1400, 900)\n\twin.Connect(\"destroy\", gtk.MainQuit)\n\n\thmain, _ := gtk.BoxNew(gtk.ORIENTATION_HORIZONTAL, 0)\n\n\t// LEFT: VERTICAL BUTTON STACK\n\tleftBar, _ := gtk.BoxNew(gtk.ORIENTATION_VERTICAL, 10)\n\tleftBar.SetMarginStart(10)\n\tleftBar.SetMarginEnd(10)\n\tleftBar.SetMarginTop(10)\n\t\n\tbtnBuild := newBtn(\"Build Context\")\n\tbtnCopy := newBtn(\"Copy Context\")\n\tbtnPaste := newBtn(\"Apply Patch\")\n\t\n\tleftBar.PackStart(btnBuild, false, false, 0)\n\tleftBar.PackStart(btnCopy, false, false, 0)\n\tleftBar.PackStart(btnPaste, false, false, 0)\n\t\n\tlabel(leftBar, \"STASHES\")\n\tstashList, _ := gtk.ListBoxNew()\n\tleftBar.PackStart(stashList, true, true, 0)\n\n\t// RIGHT: SPLIT VIEW (STATS TOP / WEB BOTTOM)\n\trightStack, _ := gtk.PanedNew(gtk.ORIENTATION_VERTICAL)\n\n\t// Stats Area\n\tstatsScroll, _ := gtk.ScrolledWindowNew(nil, nil)\n\tstatsView, _ := gtk.TextViewNew()\n\tstatsView.SetEditable(false)\n\tstatsBuf, _ := statsView.GetBuffer()\n\tstatsScroll.Add(statsView)\n\trightStack.Pack1(statsScroll, true, false)\n\n\t// Webview Logic Panel\n\twebContainer, _ := gtk.BoxNew(gtk.ORIENTATION_VERTICAL, 0)\n\turlEntry, _ := gtk.EntryNew()\n\turlEntry.SetPlaceholderText(\"Paste AI URL or JSON content here...\")\n\twebContainer.PackStart(urlEntry, false, false, 5)\n\t\n\t// Placeholder for where the Webview lives (it is a native overlay)\n\twebArea, _ := gtk.DrawingAreaNew()\n\twebArea.SetSizeRequest(-1, 400)\n\twebContainer.PackStart(webArea, true, true, 0)\n\t\n\trightStack.Pack2(webContainer, true, true)\n\n\t// LOGIC: BUILD\n\tbtnBuild.Connect(\"clicked\", func() {\n\t\tstatsBuf.SetText(\"Building...\")\n\t\tgo func() {\n\t\t\tout, err := builder.BuildSelectiveContext(\".\", nil)\n\t\t\tif err == nil {\n\t\t\t\tactiveContext = out\n\t\t\t\tjs, _ := json.Marshal(out)\n\t\t\t\tcurrentPayload = string(js)\n\t\t\t\tglib.IdleAdd(func() {\n\t\t\t\t\tstatsBuf.SetText(formatStats(activeContext))\n\t\t\t\t})\n\t\t\t}\n\t\t}()\n\t})\n\n\t// LOGIC: COPY\n\tbtnCopy.Connect(\"clicked\", func() {\n\t\tclip, _ := gtk.ClipboardGet(gdk.SELECTION_CLIPBOARD)\n\t\tclip.SetText(currentPayload)\n\t})\n\n\t// LOGIC: WEBVIEW INTEGRATION\n\turlEntry.Connect(\"activate\", func() {\n\t\ttxt, _ := urlEntry.GetText()\n\t\tif strings.HasPrefix(txt, \"http\") {\n\t\t\tgo launchWebview(txt)\n\t\t} else {\n\t\t\t// If it is not a URL, treat it as a JSON input monitor\n\t\t\tmonitorInput(txt, statsBuf)\n\t\t}\n\t})\n\n\thmain.PackStart(leftBar, false, false, 0)\n\thmain.PackStart(rightStack, true, true, 0)\n\t\n\trefreshStashes(stashList)\n\twin.Add(hmain)\n\twin.ShowAll()\n\tgtk.Main()\n}\n\nfunc formatStats(p model.ProjectOutput) string {\n\tvar sb strings.Builder\n\tsb.WriteString(fmt.Sprintf(\"PROJ: %d FILES\\n\", len(p.Files)))\n\tsb.WriteString(fmt.Sprintf(\"TOKENS: %d\\n\", p.EstimatedTokens))\n\tsb.WriteString(\"\\nDIRECTORY STRUCTURE:\\n\")\n\tsb.WriteString(p.ProjectTree)\n\treturn sb.String()\n}\n\nfunc monitorInput(input string, buf *gtk.TextBuffer) {\n\tre := regexp.MustCompile(`(?s)\\{.*\\\"files\\\".*\\}`)\n\tmatch := re.FindString(input)\n\tif match != \"\" {\n\t\tvar patch model.ProjectOutput\n\t\tjson.Unmarshal([]byte(match), \u0026patch)\n\t\tlist := \"FILES TO CHANGE:\\n\"\n\t\tfor f := range patch.Files {\n\t\t\tlist += \"- \" + f + \"\\n\"\n\t\t}\n\t\tbuf.SetText(list + \"\\nClick Apply Patch to finalize.\")\n\t}\n}\n\nfunc launchWebview(url string) {\n\tglib.IdleAdd(func() {\n\t\tw := webview.New(false)\n\t\tw.SetTitle(\"AI Interface\")\n\t\tw.SetSize(1000, 800, webview.Hint(0))\n\t\tw.Navigate(url)\n\t\tw.Run()\n\t})\n}\n\nfunc refreshStashes(list *gtk.ListBox) {\n\tglib.IdleAdd(func() bool {\n\t\tlist.GetChildren().Foreach(func(item interface{}) { list.Remove(item.(gtk.IWidget)) })\n\t\tfilepath.Walk(\".stashes\", func(path string, info os.FileInfo, err error) error {\n\t\t\tif err == nil \u0026\u0026 info.IsDir() \u0026\u0026 path != \".stashes\" \u0026\u0026 filepath.Dir(path) == \".stashes\" {\n\t\t\t\trow, _ := gtk.ListBoxRowNew()\n\t\t\t\tlbl, _ := gtk.LabelNew(filepath.Base(path))\n\t\t\t\trow.Add(lbl)\n\t\t\t\tlist.Add(row)\n\t\t\t}\n\t\t\treturn nil\n\t\t})\n\t\tlist.ShowAll()\n\t\treturn false\n\t})\n}\n\nfunc newBtn(l string) *gtk.Button { b, _ := gtk.ButtonNewWithLabel(l); return b }\nfunc label(box *gtk.Box, t string) { l, _ := gtk.LabelNew(t); l.SetXAlign(0); box.PackStart(l, false, false, 5) }\n"
  }
}